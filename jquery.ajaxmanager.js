!function(l){"use strict";var u={},c={};l.manageAjax={create:function(e,t){return u[e]=new l.manageAjax._manager(e,t),u[e]},destroy:function(e){u[e]&&(u[e].clear(!0),delete u[e])}},l.manageAjax._manager=function(e,t){this.requests={},this.inProgress=0,this.name=e,this.qName=e,this.opts=l.extend({},l.manageAjax.defaults,t),t&&t.queue&&!0!==t.queue&&"string"==typeof t.queue&&"clear"!==t.queue&&(this.qName=t.queue)},l.manageAjax._manager.prototype={add:function(e,a){"object"==typeof e?a=e:"string"==typeof e&&(a=l.extend(a||{},{url:e}));var s=(a=l.extend({},this.opts,a)).complete||l.noop,r=a.success||l.noop,u=a.beforeSend||l.noop,n=a.error||l.noop,o="string"==typeof a.data?a.data:l.param(a.data||{}),i=a.type+a.url+o,c=this,t=this._createAjax(i,a,r,s);if(a.preventDoubleRequests&&a.queueDuplicateRequests&&(a.preventDoubleRequests&&(a.queueDuplicateRequests=!1),setTimeout(function(){throw"preventDoubleRequests and queueDuplicateRequests can't be both true"},0)),!this.requests[i]||!a.preventDoubleRequests)return t.xhrID=i,a.xhrID=i,a.beforeSend=function(e,t){var s=u.call(this,e,t);return!1===s&&c._removeXHR(i),e=null,s},a.complete=function(e,t){c._complete.call(c,this,s,e,t,i,a),e=null},a.success=function(e,t,s){c._success.call(c,this,r,e,t,s,a),s=null},a.error=function(e,t,s){var r="",u="";"timeout"!==t&&e&&(r=e.status,u=e.responseXML||e.responseText),n?n.call(this,e,t,s,a):setTimeout(function(){throw t+"| status: "+r+" | URL: "+a.url+" | data: "+o+" | thrown: "+s+" | response: "+u},0),e=null},"clear"===a.queue&&l(document).clearQueue(this.qName),a.queue||a.queueDuplicateRequests&&this.requests[i]?(l.queue(document,this.qName,t),!(this.inProgress<a.maxRequests)||this.requests[i]&&a.queueDuplicateRequests||l.dequeue(document,this.qName),i):t()},_createAjax:function(e,t,s,r){var u=this;return function(){if(!1!==t.beforeCreate.call(t.context||u,e,t))return u.inProgress++,1===u.inProgress&&l.event.trigger(u.name+"AjaxStart"),t.cacheResponse&&c[e]&&(!c[e].cacheTTL||c[e].cacheTTL<0||(new Date).getTime()-c[e].timestamp<c[e].cacheTTL?(u.requests[e]={},setTimeout(function(){u._success.call(u,t.context||t,s,c[e]._successData,"success",c[e],t),u._complete.call(u,t.context||t,r,c[e],"success",e,t)},0)):delete c[e]),t.cacheResponse&&c[e]||(t.async?u.requests[e]=l.ajax(t):l.ajax(t)),e}},_removeXHR:function(e){(this.opts.queue||this.opts.queueDuplicateRequests)&&l.dequeue(document,this.qName),this.inProgress--,this.requests[e]=null,delete this.requests[e]},clearCache:function(){c={}},_isAbort:function(e,t,s){if(!s.abortIsNoSuccess||!e&&!t)return!1;var r=!(e&&0!==e.readyState&&this.lastAbort!==s.xhrID);return e=null,r},_complete:function(e,t,s,r,u,a){this._isAbort(s,r,a)&&(r="abort",a.abort.call(e,s,r,a)),t.call(e,s,r,a),l.event.trigger(this.name+"AjaxComplete",[s,r,a]),a.domCompleteTrigger&&l(a.domCompleteTrigger).trigger(this.name+"DOMComplete",[s,r,a]).trigger("DOMComplete",[s,r,a]),this._removeXHR(u),this.inProgress||l.event.trigger(this.name+"AjaxStop"),s=null},_success:function(e,t,s,r,u,a){var n=this;if(this._isAbort(u,r,a))u=null;else{if(a.abortOld&&l.each(this.requests,function(e){if(e===a.xhrID)return!1;n.abort(e)}),a.cacheResponse&&!c[a.xhrID]&&(u=u||{},c[a.xhrID]={status:u.status,statusText:u.statusText,responseText:u.responseText,responseXML:u.responseXML,_successData:s,cacheTTL:a.cacheTTL,timestamp:(new Date).getTime()},"getAllResponseHeaders"in u)){var o,i=u.getAllResponseHeaders();l.extend(c[a.xhrID],{getAllResponseHeaders:function(){return i},getResponseHeader:function(e){return o||(o={},l.each(i.split("\n"),function(e,t){var s=t.indexOf(":");o[t.substr(0,s)]=t.substr(s+2)})),e in o?o[e]:null}})}t.call(e,s,r,u,a),l.event.trigger(this.name+"AjaxSuccess",[u,a,s]),a.domSuccessTrigger&&l(a.domSuccessTrigger).trigger(this.name+"DOMSuccess",[s,a]).trigger("DOMSuccess",[s,a]),u=null}},getData:function(s){if(s){var e=this.requests[s];return!e&&this.opts.queue&&(e=l.grep(l(document).queue(this.qName),function(e,t){return e.xhrID===s})[0]),e}return{requests:this.requests,queue:this.opts.queue?l(document).queue(this.qName):[],inProgress:this.inProgress}},abort:function(e){var s;if(e)return(s=this.getData(e))&&s.abort?(this.lastAbort=e,s.abort(),this.lastAbort=!1):l(document).queue(this.qName,l.grep(l(document).queue(this.qName),function(e,t){return e!==s})),void(s=null);var r=this,t=[];l.each(this.requests,function(e){t.push(e)}),l.each(t,function(e,t){r.abort(t)})},clear:function(e){l(document).clearQueue(this.qName),e&&this.abort()}},l.manageAjax._manager.prototype.getXHR=l.manageAjax._manager.prototype.getData,l.manageAjax.defaults={beforeCreate:l.noop,abort:l.noop,abortIsNoSuccess:!0,maxRequests:1,cacheResponse:!1,async:!0,domCompleteTrigger:!1,domSuccessTrigger:!1,preventDoubleRequests:!0,queueDuplicateRequests:!1,cacheTTL:-1,queue:!1},l.each(l.manageAjax._manager.prototype,function(r,e){0!==r.indexOf("_")&&l.isFunction(e)&&(l.manageAjax[r]=function(e,t){if(!u[e]){if("add"!==r)return;l.manageAjax.create(e,t)}var s=Array.prototype.slice.call(arguments,1);u[e][r].apply(u[e],s)})})}(jQuery);
